<section class="page-header">
    <div>
      <p class="eyebrow">CSVエクスポート</p>
      <h1>出力項目の選択</h1>
    </div>
  </section>
  
  <section class="card">
    <header>
      <div>
        <h2>項目を選択</h2>
      </div>
      <div class="actions">
        <button type="button" class="ghost" [disabled]="!canSelectItems" (click)="selectAll()">
          すべて選択
        </button>
        <button type="button" class="ghost" [disabled]="!canSelectItems" (click)="deselectAll()">
          すべて解除
        </button>
        <button
          type="button"
          class="primary"
          [disabled]="isExporting || !canSelectItems || isPayrollRangeIncomplete"
          (click)="exportCsv()"
        >
          {{ isExporting ? '生成中...' : 'CSVを出力' }}
        </button>
        <span class="status" *ngIf="statusMessage">{{ statusMessage }}</span>
      </div>
    </header>
  
    <div class="filters">
      <div class="filter-field">
        <label for="department">部署</label>
        <select
          id="department"
          [(ngModel)]="selectedDepartment"
          (ngModelChange)="onFilterChange()"
        >
          <option value="">選択してください</option>
          <option *ngFor="let department of departmentOptions" [ngValue]="department">
            {{ department === EXPORT_ALL ? 'すべて' : department }}
          </option>
        </select>
      </div>
      <div class="filter-field">
        <label for="workPrefecture">勤務地</label>
        <select
          id="workPrefecture"
          [(ngModel)]="selectedWorkPrefecture"
          (ngModelChange)="onFilterChange()"
        >
          <option value="">選択してください</option>
          <option *ngFor="let prefecture of workPrefectureOptions" [ngValue]="prefecture">
            {{ prefecture === EXPORT_ALL ? 'すべて' : prefecture }}
          </option>
        </select>
      </div>
      <div class="filter-field" *ngIf="selectedSections.has('payrollHistory')">
        <label for="payrollStartMonth">給与履歴 開始年月</label>
        <input
          id="payrollStartMonth"
          type="month"
          [(ngModel)]="payrollStartMonth"
          (ngModelChange)="onPayrollRangeChange()"
        />
      </div>
      <div class="filter-field" *ngIf="selectedSections.has('payrollHistory')">
        <label for="payrollEndMonth">給与履歴 終了年月</label>
        <input
          id="payrollEndMonth"
          type="month"
          [(ngModel)]="payrollEndMonth"
          (ngModelChange)="onPayrollRangeChange()"
        />
      </div>
    </div>
    <p class="hint" *ngIf="!canSelectItems">
      まず部署と勤務地を選択してください。選択後に出力項目を設定できます。
    </p>
    <p class="hint" *ngIf="canSelectItems && selectedSections.has('payrollHistory') && isPayrollRangeIncomplete">
      給与履歴の開始年月と終了年月を指定してください。
    </p>
    <p class="hint" *ngIf="selectedSections.has('payrollHistory') && payrollStartMonth && payrollEndMonth && payrollStartMonth > payrollEndMonth">
      開始年月は終了年月以前を指定してください。
    </p>


    <ul class="option-list">
      <li *ngFor="let option of visibleOptions" class="option">
        <label>
          <input
            type="checkbox"
            [checked]="selectedSections.has(option.key)"
            [disabled]="!canSelectItems"
            (change)="onToggle(option.key, ($any($event.target)?.checked) ?? false)"
          />
          <div>
            <div class="option-title">{{ option.label }}</div>
            <p class="description">{{ option.description }}</p>
            <div *ngIf="option.key === 'basic'" class="dependent-checkbox">
              <label class="dependent-label">
                <input
                  type="checkbox"
                  [(ngModel)]="includeDependents"
                  [disabled]="!canSelectItems || !selectedSections.has('basic')"
                />
                <span>扶養情報も出力する</span>
                <small style="font-size: 0.85em; color: #666; margin-left: 0.5em;">※扶養人数が複数の場合は、複数行になります。</small>
              </label>
            </div>
          </div>
        </label>
      </li>
    </ul>

    <div
      *ngIf="isCalculationContext && selectedSections.has('calculationResult')"
      class="calculation-field-panel"
    >
      <div class="panel-header">
        <div>
          <p class="hint">※表示されている金額は、計算結果の履歴であり、最新の情報ではありません。</p>
        </div>
        <div class="actions">
          <button type="button" class="ghost" [disabled]="!canSelectItems" (click)="initializeCalculationFields()">
            すべて選択
          </button>
          <button type="button" class="ghost" [disabled]="!canSelectItems" (click)="selectedCalculationFields.clear()">
            すべて解除
          </button>
        </div>
      </div>
      <div class="calculation-field-grid">
        <label *ngFor="let field of calculationFieldOptions" class="calc-field">
          <input
            type="checkbox"
            [checked]="selectedCalculationFields.has(field.key)"
            [disabled]="!canSelectItems"
            (change)="onToggleCalculationField(field.key, ($any($event.target)?.checked) ?? false)"
          />
          <span>{{ field.header }}</span>
        </label>
      </div>
    </div>
  </section>