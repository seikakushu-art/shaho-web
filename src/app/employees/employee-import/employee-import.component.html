<section class="import-page">
    <header class="page-header">
        <div>
            <div class="title-row">
                <h1>CSV一括アップロード</h1>
            </div>
        </div>
    </header>

    <div class="stepper">
        <div class="step" *ngFor="let step of steps" [class.active]="currentStep === step.number"
            [class.visited]="step.number <= maxStep" (click)="goToStep(step.number)">
            <div class="step-index">{{ step.number }}</div>
            <div>
                <p class="step-title">{{ step.title }}</p>
            </div>
        </div>
    </div>

    <!-- Step 1: Template download -->
    <section class="panel" *ngIf="currentStep === 1">
        <div class="panel-header">
            <div>
                <p class="eyebrow">Step 1</p>
                <h2>テンプレートをダウンロード</h2>
            </div>
        </div>
        <div class="action-grid">
            <button type="button" class="primary" (click)="downloadNewEmployeeTemplate()">新規登録/一括更新用テンプレート</button>
            <button type="button" class="primary" (click)="downloadPayrollTemplate()">月給/賞与支払額同期用テンプレート</button>
        </div>
        <div class="notes">
            <ul>
                <li><strong>必須項目（新規登録時）：</strong>社員番号、氏名(漢字)、氏名(カナ)、性別（男/女）、生年月日（YYYY/MM/DD）、所属部署名、勤務地都道府県名、健康保険資格取得日（YYYY/MM/DD）、厚生年金資格取得日（YYYY/MM/DD）<br><span class="hint">※既存社員の更新時は、社員番号と氏名(漢字)のみ必須です。</span></li>
                <li><strong>複数扶養家族の追加方法：</strong>
                    <ul>
                        <li>複数の扶養家族を追加する場合は、同じ社員番号で複数行に分けて記入してください。</li>
                        <li><strong>1行目（従業員情報行）：</strong>社員番号と従業員情報（氏名など）を記入します。この行で扶養家族情報も記入できます。</li>
                        <li><strong>2行目以降（扶養家族追加行）：</strong>社員番号のみ必須です。従業員情報の列（氏名、性別、生年月日など）は空欄でも構いません。</li>
                        <li><strong>注意：</strong>扶養の有無が「無」の場合、扶養家族情報はインポートできません。</li>
                    </ul>
                </li>
                <li><strong>ファイル形式：</strong>文字コードはUTF-8、改行コードはLFで保存してください。</li>
                <li><strong>入力形式：</strong>日付はYYYY/MM/DD形式、金額などはカンマ無しの半角数字で入力してください。</li>
            </ul>
        </div>
        <div class="navigation">
            <span></span>
            <button type="button" class="primary" (click)="unlockStep(2); nextStep()">次へ進む</button>
        </div>
    </section>

    <!-- Step 2: CSV upload -->
    <section class="panel" *ngIf="currentStep === 2">
        <div class="panel-header">
            <div>
                <p class="eyebrow">Step 2</p>
                <h2>CSVファイルを選択</h2>
            </div>
            <div class="file-input">
                <label class="upload">
                    <input type="file" accept=".csv" (change)="onFileSelect($event)" />
                    <span>{{ fileName || 'ファイルを選択' }}</span>
                </label>
            </div>
        </div>
        <div class="summary-grid" *ngIf="hasUploadedFile">
            <div class="summary-card">
                <p class="label">総レコード数</p>
                <p class="value">{{ summary.totalRecords | number }} 件</p>
            </div>
            <div class="summary-card">
                <p class="label">新規登録対象</p>
                <p class="value highlight">{{ summary.newCount | number }} 件</p>
            </div>
            <div class="summary-card">
                <p class="label">更新対象</p>
                <p class="value highlight">{{ summary.updateCount | number }} 件</p>
            </div>
            <div class="summary-card error">
                <p class="label">エラー件数</p>
                <p class="value">{{ summary.errorCount | number }} 件</p>
            </div>
        </div>
        <div class="navigation">
            <button type="button" class="ghost" (click)="prevStep()">戻る</button>
            <button type="button" class="primary" [disabled]="!hasUploadedFile" (click)="nextStep()">検証へ進む</button>
        </div>
    </section>

    <!-- Step 3: Error validation -->
    <section class="panel" *ngIf="currentStep === 3">
        <div class="panel-header">
            <div>
                <p class="eyebrow">Step 3</p>
                <h2>取込結果の検証</h2>
                <p class="hint">形式エラーや必須項目の欠落を表示しています。エラー行は自動的に「更新対象外」となります。</p>
            </div>
            <div class="badge-list">
                <span class="badge" [class.error]="summary.errorCount > 0" [class.success]="summary.errorCount === 0">
                    <span *ngIf="summary.errorCount > 0">エラー {{ summary.errorCount }} 件</span>
                    <span *ngIf="summary.errorCount === 0">エラーなし</span>
                </span>
            </div>
        </div>
        <div class="table-wrapper" *ngIf="summary.errorCount > 0">
            <div class="action-bar">
                <button type="button" class="ghost" (click)="downloadErrorReport()">
                    エラーレポートをダウンロード（CSV）
                </button>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>行番号</th>
                        <th>社員番号</th>
                        <th>氏名</th>
                        <th>エラー内容</th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let error of errors">
                        <td>{{ error.rowIndex || 'ー' }}</td>
                        <td>{{ error.employeeNo || 'ー' }}</td>
                        <td>{{ error.name || 'ー' }}</td>
                        <td class="error-text">{{ error.message }}</td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div class="success-message" *ngIf="summary.errorCount === 0">
            <p>✅ 検証が完了しました。エラーはありませんでした。</p>
            <p class="hint">すべてのレコードが正常に検証されました。次のステップで差分確認に進みます。</p>
        </div>
        <div class="navigation">
            <button type="button" class="ghost" (click)="prevStep()">戻る</button>
            <button type="button" class="primary" (click)="nextStep()">差分確認へ進む</button>
        </div>
    </section>

    <!-- Step 4: Difference review -->
    <section class="panel" *ngIf="currentStep === 4">
        <div class="panel-header">
            <div>
                <p class="eyebrow">Step 4</p>
                <h2>差分確認</h2>
                <p class="hint">更新対象に含める社員を選択し、詳細差分を確認してください。</p>
            </div>
            <div class="filters">
                <label>ステータス</label>
                <select [(ngModel)]="statusFilter" (change)="setFilter(statusFilter)">
                    <option value="all">すべて</option>
                    <option value="ok">OK</option>
                    <option value="warning">警告</option>
                    <option value="error">エラー</option>
                </select>
                <button type="button" class="ghost" (click)="toggleAll(true)">すべて選択</button>
                <button type="button" class="ghost" (click)="toggleAll(false)">すべて解除</button>
            </div>
        </div>

        <div class="diff-layout">
            <div class="table-wrapper">
                <table class="diff-table">
                    <thead>
                        <tr>
                            <th class="checkbox-col"></th>
                            <th>ステータス</th>
                            <th>社員番号</th>
                            <th>氏名</th>
                            <th>変更サマリ</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let row of filteredDifferences" (click)="selectRow(row)"
                            [class.selected]="selectedChangeId === row.id">
                            <td class="checkbox-col">
                                <input type="checkbox" [disabled]="row.status === 'error'" [checked]="row.selected"
                                    (click)="toggleSelection(row, $event)" />
                            </td>
                            <td>
                                <span [class]="statusClass(row.status)">{{ statusLabel(row.status) }}</span>
                            </td>
                            <td>{{ row.employeeNo }}</td>
                            <td>{{ row.name }}</td>
                            <td>{{ row.summary }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="detail-panel" *ngIf="selectedChangeId && changeDetail(selectedChangeId) as detail">
                <div class="detail-header">
                    <p class="eyebrow">差分詳細</p>
                    <h3>{{ detail.employeeNo }} {{ detail.name }}</h3>
                </div>
                <div class="detail-body">
                    <div class="change-row" *ngFor="let change of detail.changes">
                        <div class="field">{{ change.field }}</div>
                        <div class="old">{{ change.oldValue }}</div>
                        <div class="arrow">→</div>
                        <div class="new">{{ change.newValue }}</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="navigation">
            <button type="button" class="ghost" (click)="prevStep()">戻る</button>
            <div class="spacer"></div>
            <button type="button" class="primary" (click)="nextStep()">承認依頼へ進む</button>
        </div>
    </section>

    <!-- Step 5: Approval -->
    <section class="panel" *ngIf="currentStep === 5">
        <div class="panel-header">
            <div>
                <p class="eyebrow">Step 5</p>
                <h2>承認依頼</h2>
            </div>
        </div>

        <div class="approval-grid">
            <div class="approval-summary">
                <p class="label">対象社員件数</p>
                <p class="value">{{ selectedCount }} 件</p>
                <ul>
                    <li>OK：{{ okCount }} 件</li>
                    <li>警告あり：{{ warningCount }} 件</li>
                    <li>エラー除外：{{ summary.errorCount }} 件</li>
                </ul>
            </div>
            <div class="approval-form">
                <app-flow-selector
                  [label]="'承認ルート'"
                  [selectedFlowId]="selectedFlowId"
                  (flowSelected)="onFlowSelected($event)"
                  (flowsUpdated)="onFlowsUpdated($event)"
                />
                <label class="field">
                    <div class="field-header">
                        <span>申請コメント</span>
                        <span class="hint" [class.warning]="requestComment.length >= 450">
                            {{ requestComment.length }}/500 文字
                        </span>
                    </div>
                    <textarea rows="4" [(ngModel)]="requestComment" placeholder="例：給与改定に伴う更新です。" maxlength="500"></textarea>
                </label>
                <div class="attachment-box">
                    <div class="attachment-header">
                        <div>
                            <p class="label">申請時の添付</p>
                            <p class="hint">1件10MB以内・最大5件・合計30MB</p>
                        </div>
                        <label class="upload-button">
                            <input
                                type="file"
                                multiple
                                (change)="onFileSelected($event)"
                                [accept]="attachmentService.acceptExtensions"
                            />
                            ファイルを選択
                        </label>
                    </div>
                    <p class="hint">合計サイズ: {{ formatFileSize(totalSelectedSize()) }}</p>
                    <p class="hint warning" *ngIf="validationErrors.length">{{ validationErrors[0] }}</p>
                    <ul class="selected-files" *ngIf="selectedFiles.length">
                        <li *ngFor="let file of selectedFiles; let i = index">
                            <div>
                                <p class="file-name">{{ file.name }}</p>
                                <p class="hint">{{ formatFileSize(file.size) }}</p>
                            </div>
                            <button type="button" class="ghost" (click)="removeFile(i)">削除</button>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="navigation">
            <button type="button" class="ghost" (click)="prevStep()">戻る</button>
            <button type="button" class="primary" (click)="submitForApproval()" [disabled]="isLoading || selectedCount === 0 || !selectedFlowId">承認依頼を送信</button>
        </div>
    </section>
</section>