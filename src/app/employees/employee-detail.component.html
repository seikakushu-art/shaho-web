<ng-container *ngIf="!isLoading; else loading">
    <section *ngIf="employee; else notFound" class="employee-detail">
        <header class="page-header">
            <div>
                <h1>{{ employee?.name || '—' }} <span class="kana">{{ employee?.kana || '' }}</span></h1>
                <p class="hint">
                    社員番号 {{ employee?.employeeNo || '—' }} ／ 所属部署: {{ employee?.department || '—' }}
                </p>
            </div>
            <div class="header-actions">
                <button *ngIf="canManage$ | async" type="button" class="secondary"
                    (click)="navigateToEdit()">編集</button>
                <button *ngIf="canDelete && (canManage$ | async)" type="button" class="danger" (click)="requestDelete()"
                    [disabled]="!employee">削除</button>
                <button type="button" class="outline" (click)="showApprovalHistory = true">承認履歴</button>
            </div>
        </header>

        <nav class="tabs">
            <button *ngFor="let tab of tabs" type="button" [class.active]="selectedTab === tab.key"
                (click)="changeTab(tab.key)">
                {{ tab.label }}
            </button>
        </nav>

        <section *ngIf="selectedTab === 'basic'" class="tab-body">
            <article class="card">
                <div class="card-header">
                    <div>
                        <h2>基本情報</h2>
                    </div>
                </div>
                <div class="grid four-col">
                    <div>
                        <label>社員番号</label>
                        <p class="value">{{ employee?.employeeNo || '—' }}</p>
                    </div>
                    <div>
                        <label>氏名</label>
                        <p class="value">{{ employee?.name || '—' }}</p>
                    </div>
                    <div>
                        <label>生年月日</label>
                        <p class="value">{{ basicInfo.birthDate ? (basicInfo.birthDate | date: 'yyyy/MM/dd') : '—' }}
                        </p>
                    </div>
                    <div>
                        <label>性別</label>
                        <p class="value">{{ basicInfo.gender || '—' }}</p>
                    </div>
                    <div>
                        <label>所属部署</label>
                        <p class="value">{{ employee?.department || '—' }}</p>
                    </div>
                    <div>
                        <label>勤務地都道府県</label>
                        <p class="value">{{ basicInfo.workPrefecture || '—' }}</p>
                    </div>
                    <div>
                        <label>個人番号</label>
                        <p class="value">{{ basicInfo.personalNumber || '—' }}</p>
                    </div>
                    <div>
                        <label>基礎年金番号</label>
                        <p class="value">{{ basicInfo.basicPensionNumber || '—' }}</p>
                    </div>
                    <div>
                        <label>扶養の有無</label>
                        <p class="value">{{ basicInfo.hasDependent ? '有' : '無' }}</p>
                    </div>
                    <div style="grid-column: span 2;">
                        <label>住民票住所</label>
                        <p class="value">{{ formattedAddress || '—' }}</p>
                    </div>
                    <div style="grid-column: span 2;" *ngIf="basicInfo.currentAddress">
                        <label>現住所</label>
                        <p class="value">{{ formattedCurrentAddress || '—' }}</p>
                    </div>
                </div>
            </article>

            <article class="card audit">
                <div class="card-header">
                    <div>
                        <h2>監査情報</h2>
                    </div>
                </div>
                <div class="grid three-col">
                    <div style="grid-column: 1; grid-row: 1;">
                        <label>登録日</label>
                        <p class="value">{{ auditInfo.registeredAt }}</p>
                    </div>
                    <div style="grid-column: 2; grid-row: 1;">
                        <label>更新日</label>
                        <p class="value">{{ auditInfo.updatedAt }}</p>
                    </div>
                    <div style="grid-column: 1; grid-row: 2;">
                        <label>登録者</label>
                        <p class="value">{{ auditInfo.createdBy }}</p>
                    </div>
                    <div style="grid-column: 2; grid-row: 2;">
                        <label>更新者</label>
                        <p class="value">{{ auditInfo.updatedBy }}</p>
                    </div>
                    <div style="grid-column: 3; grid-row: 2;">
                        <label>承認者</label>
                        <p class="value">{{ auditInfo.approvedBy }}</p>
                    </div>
                </div>
            </article>
        </section>

        <section *ngIf="selectedTab === 'insurance'" class="tab-body">
            <article class="card">
                <div class="card-header">
                    <div>
                        <h2>社会保険関連基本情報</h2>
                    </div>
                </div>
                <div class="grid two-col insurance-form">
                    <div>
                        <label>健保標準報酬月額</label>
                        <p class="value">{{ displayAmount(socialInsurance.healthStandardMonthly) }}</p>
                    </div>
                    <div>
                        <label>厚年標準報酬月額</label>
                        <p class="value">{{ displayAmount(socialInsurance.welfareStandardMonthly) }}</p>
                    </div>
                    <div>
                        <label>標準賞与額年度累計</label>
                        <p class="value">{{ displayAmount(displayedStandardBonusAnnualTotal) }}</p>
                        <p class="hint"
                            *ngIf="socialInsurance.standardBonusAnnualTotal === null || socialInsurance.standardBonusAnnualTotal === undefined">
                            ※ 給与データから自動計算した値です
                        </p>
                    </div>
                    <div>
                        <label>被保険者番号ー健康保険</label>
                        <p class="value">{{ socialInsurance.healthInsuredNumber || '—' }}</p>
                    </div>
                    <div>
                        <label>被保険者番号ー厚生年金</label>
                        <p class="value">{{ socialInsurance.pensionInsuredNumber || '—' }}</p>
                    </div>
                    <div>
                        <label>介護保険第2号被保険者フラグ</label>
                        <p class="value">{{ socialInsurance.careSecondInsured ? 'ON' : 'OFF' }}</p>
                    </div>
                    <div>
                        <label>健康保険 資格取得日</label>
                        <p class="value">{{ socialInsurance.healthAcquisition ? (socialInsurance.healthAcquisition |
                            date: 'yyyy/MM/dd') : '—' }}</p>
                    </div>
                    <div>
                        <label>厚生年金 資格取得日</label>
                        <p class="value">{{ socialInsurance.pensionAcquisition ? (socialInsurance.pensionAcquisition |
                            date: 'yyyy/MM/dd') : '—' }}</p>
                    </div>
                    <div>
                        <label>現在の休業状態</label>
                        <p class="value">{{ socialInsurance.currentLeaveStatus || '—' }}</p>
                    </div>
                    <div>
                        <label>現在の休業開始日</label>
                        <p class="value">{{ socialInsurance.currentLeaveStartDate ? (socialInsurance.currentLeaveStartDate |
                            date: 'yyyy/MM/dd') : '—' }}</p>
                    </div>
                    <div>
                        <label>現在の休業予定終了日</label>
                        <p class="value">{{ socialInsurance.currentLeaveEndDate ? (socialInsurance.currentLeaveEndDate |
                            date: 'yyyy/MM/dd') : '—' }}</p>
                    </div>
                    <div>
                        <label>健康保険・厚生年金一時免除フラグ</label>
                        <p class="value">{{ socialInsurance.exemption ? 'ON' : 'OFF' }}</p>
                        <p class="hint">※給与データと一緒にインポートする値です</p>
                    </div>
                </div>
            </article>
        </section>

        <section *ngIf="selectedTab === 'insurance-history'" class="tab-body">
            <article class="card">
                <div class="card-header">
                    <div>
                    </div>
                </div>
                <div class="grid three-col filters">
                    <div>
                        <label>開始期間</label>
                        <input type="month" [ngModel]="insuranceHistoryFilter.start"
                            (ngModelChange)="updateInsuranceHistoryRange('start', $event)" />
                    </div>
                    <div>
                        <label>終了期間</label>
                        <input type="month" [ngModel]="insuranceHistoryFilter.end"
                            (ngModelChange)="updateInsuranceHistoryRange('end', $event)" />
                    </div>
                    <div>
                        <label>表示モード</label>
                        <select [ngModel]="insuranceHistoryFilter.mode" (ngModelChange)="changeDisplayMode($event)">
                            <option value="all">月給・賞与をすべて表示</option>
                            <option value="without-bonus">賞与抜きで表示</option>
                            <option value="bonus-only">賞与のみ表示</option>
                        </select>
                    </div>
                </div>
            </article>

            <article class="card">
                <div class="card-header">
                    <div>
                        <h2>給与/賞与/社会保険料履歴</h2>
                    </div>
                    <p class="hint">過去3年分の履歴を表示します。</p>
                </div>
                <div class="table-wrapper" *ngIf="displayedMonths.length; else noHistoryRange">
                    <table>
                        <thead>
                            <tr>
                                <th>区分</th>
                                <th *ngFor="let month of displayedMonths">{{ month | date: 'yyyy年MM月' }}</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr *ngFor="let row of visibleHistoryRows">
                                <th scope="row">{{ row.label }}</th>
                                <td *ngFor="let month of displayedMonths">{{ getHistoryValue(month, row.key) }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <ng-template #noHistoryRange>
                    <p class="hint">表示可能な期間を選択してください（最大36か月）。</p>
                </ng-template>
            </article>
        </section>

        <section *ngIf="selectedTab === 'dependent'" class="tab-body">
            <article class="card" *ngFor="let dependentInfo of dependentInfos; let i = index"
                style="margin-bottom: 1.5rem;">
                <div class="card-header">
                    <div>
                        <h2>扶養情報 {{ i + 1 }}</h2>
                    </div>
                </div>
                <div class="grid three-col">
                    <div>
                        <label>続柄</label>
                        <p class="value">{{ dependentInfo.relationship || '—' }}</p>
                    </div>
                    <div>
                        <label>氏名（漢字）</label>
                        <p class="value">{{ dependentInfo.nameKanji || '—' }}</p>
                    </div>
                    <div>
                        <label>氏名（カナ）</label>
                        <p class="value">{{ dependentInfo.nameKana || '—' }}</p>
                    </div>
                    <div>
                        <label>生年月日</label>
                        <p class="value">{{ dependentInfo.birthDate ? (dependentInfo.birthDate | date: 'yyyy/MM/dd') :
                            '—' }}</p>
                    </div>
                    <div>
                        <label>性別</label>
                        <p class="value">{{ dependentInfo.gender || '—' }}</p>
                    </div>
                    <div>
                        <label>個人番号</label>
                        <p class="value">{{ dependentInfo.personalNumber || '—' }}</p>
                    </div>
                    <div>
                        <label>基礎年金番号</label>
                        <p class="value">{{ dependentInfo.basicPensionNumber || '—' }}</p>
                    </div>
                    <div>
                        <label>同居区分</label>
                        <p class="value">{{ dependentInfo.cohabitationType || '—' }}</p>
                    </div>
                    <div>
                        <label>住所（別居の場合のみ入力）</label>
                        <p class="value">{{ dependentInfo.address || '—' }}</p>
                    </div>
                    <div>
                        <label>職業</label>
                        <p class="value">{{ dependentInfo.occupation || '—' }}</p>
                    </div>
                    <div>
                        <label>年収（見込みでも可）</label>
                        <p class="value">{{ displayAmount(dependentInfo.annualIncome) }}</p>
                    </div>
                    <div>
                        <label>被扶養者になった日</label>
                        <p class="value">{{ dependentInfo.dependentStartDate ? (dependentInfo.dependentStartDate | date:
                            'yyyy/MM/dd') : '—' }}</p>
                    </div>
                    <div>
                        <label>国民年金第3号被保険者該当フラグ</label>
                        <p class="value">{{ dependentInfo.thirdCategoryFlag ? 'ON' : 'OFF' }}</p>
                    </div>
                </div>
            </article>
            <article class="card" *ngIf="dependentInfos.length === 0">
                <div class="card-header">
                    <div>
                        <h2>扶養情報</h2>
                    </div>
                </div>
                <p class="hint">扶養情報が登録されていません。</p>
            </article>
        </section>

        <section *ngIf="selectedTab === 'history'" class="tab-body">
            <article class="card">
                <div class="card-header">
                    <div>
                        <h2>変更履歴フィルター</h2>
                    </div>
                </div>
                <div class="grid three-col filters">
                    <div>
                        <label>期間（From）</label>
                        <input type="date" [(ngModel)]="historyFilters.from" />
                    </div>
                    <div>
                        <label>期間（To）</label>
                        <input type="date" [(ngModel)]="historyFilters.to" />
                    </div>
                    <div>
                        <label>項目名</label>
                        <input type="text" [(ngModel)]="historyFilters.field" placeholder="項目名を入力してください"
                            autocomplete="off" />
                    </div>
                    <div>
                        <label>操作者</label>
                        <input type="text" [(ngModel)]="historyFilters.actor" placeholder="user id or name" />
                    </div>
                </div>
            </article>

            <article class="card">
                <div class="card-header">
                    <div>
                        <p class="eyebrow">変更履歴</p>
                        <h2>履歴テーブル</h2>
                    </div>
                    <p class="hint">行クリックで同一更新操作をモーダル表示</p>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>変更日時</th>
                            <th>項目名</th>
                            <th>旧値</th>
                            <th>新値</th>
                            <th>操作者</th>
                            <th>承認者</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let record of filteredHistory" (click)="openHistoryGroup(record.groupId)">
                            <td>{{ record.changedAt }}</td>
                            <td>{{ record.field }}</td>
                            <td>{{ record.oldValue }}</td>
                            <td>{{ record.newValue }}</td>
                            <td>{{ record.actor }}</td>
                            <td>{{ record.approver }}</td>
                        </tr>
                    </tbody>
                </table>
            </article>
        </section>

        <div class="modal" *ngIf="groupedHistory.length">
            <div class="modal-content">
                <header>
                    <h3>同一操作の変更一覧</h3>
                    <button type="button" (click)="closeHistoryGroup()">閉じる</button>
                </header>
                <ul>
                    <li *ngFor="let record of groupedHistory">
                        <span class="field">{{ record.field }}</span>
                        <span class="old">{{ record.oldValue }}</span>
                        <span class="new">→ {{ record.newValue }}</span>
                        <span class="meta">{{ record.changedAt }} / 操作者: {{ record.actor }} / 承認者: {{ record.approver
                            }}</span>
                    </li>
                </ul>
            </div>
        </div>

        <div class="modal" *ngIf="showApprovalHistory">
            <div class="modal-content">
                <header>
                    <h3>承認履歴</h3>
                    <button type="button" (click)="showApprovalHistory = false">閉じる</button>
                </header>
                <ng-container *ngIf="approvalHistoryEntries.length; else noApprovalHistory">
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>日時</th>
                                    <th>区分</th>
                                    <th>申請タイトル</th>
                                    <th>アクション</th>
                                    <th>ステータス</th>
                                    <th>実行者</th>
                                    <th>コメント</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr *ngFor="let history of approvalHistoryEntries">
                                    <td>{{ history.createdAt | date: 'yyyy/MM/dd HH:mm' }}</td>
                                    <td>{{ history.category }}</td>
                                    <td>{{ history.requestTitle }}</td>
                                    <td>{{ history.actionLabel }}</td>
                                    <td>{{ history.statusLabel }}</td>
                                    <td>{{ history.actor }}</td>
                                    <td>{{ history.comment || '—' }}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </ng-container>
                <ng-template #noApprovalHistory>
                    <p class="hint">該当する承認履歴がありません。</p>
                </ng-template>
            </div>
        </div>
    </section>
</ng-container>

<ng-template #loading>
    <section class="employee-detail">
        <p class="hint">社員情報を読み込み中です…</p>
    </section>
</ng-template>

<ng-template #notFound>
    <section class="employee-detail">
        <p class="hint">該当する社員情報が見つかりませんでした。</p>
    </section>
</ng-template>

<!-- 削除承認依頼モーダル -->
<section *ngIf="showDeletePanel" class="modal-overlay" (click)="cancelDelete()">
    <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="panel-header">
            <div>
                <h2>社員削除の承認依頼</h2>
            </div>
            <button type="button" class="ghost" (click)="cancelDelete()">×</button>
        </div>

        <div class="approval-grid">
            <div class="approval-summary">
                <p class="label">削除対象</p>
                <p class="value">{{ employee?.name || '—' }}</p>
                <p class="hint">社員番号: {{ employee?.employeeNo || '—' }}</p>
            </div>
            <div class="approval-form">
                <app-flow-selector [label]="'承認ルート'" [selectedFlowId]="selectedDeleteFlowId"
                    (flowSelected)="onDeleteFlowSelected($event)" (flowsUpdated)="onDeleteFlowsUpdated($event)" />
                <label class="field">
                    <div class="field-header">
                        <span>申請コメント</span>
                        <span class="hint" [class.warning]="deleteComment.length >= 450">
                            {{ deleteComment.length }}/500 文字
                        </span>
                    </div>
                    <textarea rows="4" [(ngModel)]="deleteComment" placeholder="例：退職に伴う削除です。"
                        maxlength="500"></textarea>
                </label>
                <div class="attachment-box">
                    <div class="attachment-header">
                        <div>
                            <p class="label">申請時の添付</p>
                            <p class="hint">1件10MB以内・最大5件・合計30MB</p>
                        </div>
                        <label class="upload-button">
                            <input type="file" multiple (change)="onFileSelected($event)"
                                [accept]="attachmentService.acceptExtensions" />
                            ファイルを選択
                        </label>
                    </div>
                    <p class="hint">合計サイズ: {{ formatFileSize(totalSelectedSize()) }}</p>
                    <p class="hint warning" *ngIf="validationErrors.length">{{ validationErrors[0] }}</p>
                    <ul class="selected-files" *ngIf="selectedFiles.length">
                        <li *ngFor="let file of selectedFiles; let i = index">
                            <div>
                                <p class="file-name">{{ file.name }}</p>
                                <p class="hint">{{ formatFileSize(file.size) }}</p>
                            </div>
                            <button type="button" class="ghost" (click)="removeFile(i)">削除</button>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <p class="message" *ngIf="deleteMessage">{{ deleteMessage }}</p>

        <div class="navigation">
            <button type="button" class="ghost" (click)="cancelDelete()" [disabled]="isDeleting">キャンセル</button>
            <button type="button" class="primary danger" (click)="submitDeleteApproval()"
                [disabled]="isDeleting || !selectedDeleteFlowId">承認依頼を送信</button>
        </div>
    </div>
</section>