<section class="employee-create">
    <header class="page-header">
      <div>
        <h1>{{ isEditMode ? '社員編集' : '社員新規登録' }}</h1>
      </div>
      <div class="header-actions" *ngIf="!isViewModeFromApproval">
        <a [routerLink]="isEditMode ? '/employees/' + employeeId : '/employees'" class="outline ghost">
          {{ isEditMode ? '社員詳細に戻る' : '社員一覧に戻る' }}
        </a>
      </div>
    </header>
  
    <form #employeeForm="ngForm" novalidate>
      <article class="card">
        <div class="card-header">
          <div>
            <h2>基本情報</h2>
          </div>
          <p class="hint"> * は必須項目</p>
        </div>
  
        <div class="grid four-col">
          <div>
            <label>社員番号 *</label>
            <input
              name="employeeNo"
              [(ngModel)]="basicInfo.employeeNo"
              required
              [readonly]="isEditMode || !editMode"
              (blur)="checkEmployeeNoDuplicate()"
              #employeeNoModel="ngModel"
            />
            <p class="error" *ngIf="employeeNoModel.invalid && (submitAttempted || employeeNoModel.touched)">
              社員番号は必須です。
            </p>
            <p class="error" *ngIf="employeeNoDuplicateError">
              {{ employeeNoDuplicateError }}
            </p>
            <p class="hint" *ngIf="checkingDuplicate">
              重複チェック中...
            </p>
          </div>
          <div>
            <label>氏名 *</label>
            <input
              name="name"
              [(ngModel)]="basicInfo.name"
              required
              [readonly]="!editMode"
              #nameModel="ngModel"
            />
            <p class="error" *ngIf="nameModel.invalid && (submitAttempted || nameModel.touched)">
              氏名は必須です。
            </p>
          </div>
          <div>
            <label>氏名（カナ） *</label>
            <input
              name="kana"
              [(ngModel)]="basicInfo.kana"
              required
              [readonly]="!editMode"
              #kanaModel="ngModel"
            />
            <p class="error" *ngIf="kanaModel.invalid && (submitAttempted || kanaModel.touched)">
              カナは必須です。
            </p>
          </div>
          <div>
            <label>性別</label>
            <select name="gender" [(ngModel)]="basicInfo.gender" [disabled]="!editMode">
              <option value="">選択してください</option>
              <option value="男性">男性</option>
              <option value="女性">女性</option>
            </select>
          </div>
          <div>
            <label>生年月日 *</label>
            <input
              type="date"
              name="birthDate"
              [(ngModel)]="basicInfo.birthDate"
              required
              [readonly]="!editMode"
              #birthDateModel="ngModel"
            />
            <p class="error" *ngIf="birthDateModel.invalid && (submitAttempted || birthDateModel.touched)">
              生年月日は必須です。
            </p>
          </div>
          <div>
            <label>所属部署 *</label>
            <input
              name="department"
              [(ngModel)]="basicInfo.department"
              required
              [readonly]="!editMode"
              #deptModel="ngModel"
            />
            <p class="error" *ngIf="deptModel.invalid && (submitAttempted || deptModel.touched)">
              所属部署は必須です。
            </p>
          </div>
          <div>
            <label>勤務地都道府県 *</label>
            <input
              name="workPrefecture"
              [(ngModel)]="basicInfo.workPrefecture"
              required
              [readonly]="!editMode"
              #workPrefectureModel="ngModel"
            />
            <p class="error" *ngIf="workPrefectureModel.invalid && (submitAttempted || workPrefectureModel.touched)">
              勤務地都道府県は必須です。
            </p>
          </div>
          <div>
            <label>個人番号</label>
            <input name="myNumber" [(ngModel)]="basicInfo.myNumber" [readonly]="!editMode" />
          </div>
          <div>
            <label>基礎年金番号</label>
            <input name="basicPensionNumber" [(ngModel)]="basicInfo.basicPensionNumber" [readonly]="!editMode" />
          </div>
          <div>
            <label>扶養の有無</label>
            <select name="hasDependent" [(ngModel)]="basicInfo.hasDependent" [disabled]="!editMode">
              <option [ngValue]="false">無</option>
              <option [ngValue]="true">有</option>
            </select>
          </div>
          <div>
            <label>郵便番号</label>
            <input name="postalCode" [(ngModel)]="basicInfo.postalCode" [readonly]="!editMode" />
          </div>
          <div>
            <label>住所</label>
            <input name="address" [(ngModel)]="basicInfo.address" [readonly]="!editMode" />
          </div>
        </div>
      </article>
  
      <article class="card">
        <div class="card-header">
          <div>
            <h2>社会保険情報</h2>
          </div>
        </div>
  
        <div class="grid three-col">
          <div>
            <label>標準報酬月額</label>
            <input
              type="number"
              name="standardMonthly"
              [(ngModel)]="socialInsurance.standardMonthly"
              [readonly]="!editMode"
            />
          </div>
          <div>
            <label style="display: flex; align-items: center; gap: 0.5rem;">
              <span>標準賞与額年度累計</span>
              <span class="hint" style="color: #94a3b8; font-size: 0.85rem; font-weight: normal;">自動集計になります。</span>
            </label>
            <input
              type="number"
              name="healthCumulative"
              [(ngModel)]="socialInsurance.healthCumulative"
              readonly
            />
          </div>
          <div>
            <label>被保険者番号一健康保険</label>
            <input
              name="healthInsuredNumber"
              [(ngModel)]="socialInsurance.healthInsuredNumber"
              [readonly]="!editMode"
            />
          </div>
          <div>
            <label>被保険者番号一厚生年金</label>
            <input
              name="pensionInsuredNumber"
              [(ngModel)]="socialInsurance.pensionInsuredNumber"
              [readonly]="!editMode"
            />
          </div>
          <div>
            <label>介護保険第2号被保険者フラグ</label>
            <label class="switch">
              <input
                type="checkbox"
                [(ngModel)]="socialInsurance.careSecondInsured"
                name="careSecond"
                [disabled]="!editMode"
              />
              <span></span>
            </label>
          </div>
          <div>
            <label>健康保険 資格取得日 *</label>
            <input
              type="date"
              name="healthAcquisition"
              [(ngModel)]="socialInsurance.healthAcquisition"
              required
              [readonly]="!editMode"
              #healthModel="ngModel"
            />
            <p class="error" *ngIf="healthModel.invalid && (submitAttempted || healthModel.touched)">
              健康保険の資格取得日は必須です。
            </p>
          </div>
          <div>
            <label>厚生年金 資格取得日 *</label>
            <input
              type="date"
              name="pensionAcquisition"
              [(ngModel)]="socialInsurance.pensionAcquisition"
              required
              [readonly]="!editMode"
              #pensionModel="ngModel"
            />
            <p class="error" *ngIf="pensionModel.invalid && (submitAttempted || pensionModel.touched)">
              厚生年金の資格取得日は必須です。
            </p>
          </div>
          <div>
            <label>育休開始日</label>
            <input
              type="date"
              name="childcareLeaveStart"
              [(ngModel)]="socialInsurance.childcareLeaveStart"
              [readonly]="!editMode"
            />
          </div>
          <div>
            <label>育休終了日</label>
            <input
              type="date"
              name="childcareLeaveEnd"
              [(ngModel)]="socialInsurance.childcareLeaveEnd"
              [readonly]="!editMode"
            />
          </div>
          <div>
            <label>産休開始日</label>
            <input
              type="date"
              name="maternityLeaveStart"
              [(ngModel)]="socialInsurance.maternityLeaveStart"
              [readonly]="!editMode"
            />
          </div>
          <div>
            <label>産休終了日</label>
            <input
              type="date"
              name="maternityLeaveEnd"
              [(ngModel)]="socialInsurance.maternityLeaveEnd"
              [readonly]="!editMode"
            />
          </div>
          <div>
            <label>健康保険・厚生年金一時免除フラグ</label>
            <label class="switch">
              <input
                type="checkbox"
                name="exemption"
                [(ngModel)]="socialInsurance.exemption"
                [disabled]="!editMode"
              />
              <span></span>
            </label>
          </div>
        </div>
      </article>

      <article class="card">
        <div class="card-header">
          <div>
            <h2>扶養情報</h2>
          </div>
          <button
            *ngIf="basicInfo.hasDependent && editMode"
            type="button"
            class="ghost"
            (click)="addDependentInfo()"
          >
            ＋扶養情報追加
          </button>
        </div>

        <div *ngIf="basicInfo.hasDependent; else noDependentNotice">
          <div
            *ngFor="let dependentInfo of dependentInfos; let i = index"
            class="dependent-card"
            style="margin-bottom: 1.5rem; padding: 1.5rem; border: 1px solid #e0e0e0; border-radius: 8px;"
          >
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
              <h3 style="margin: 0; font-size: 1.1rem;">扶養情報 {{ i + 1 }}</h3>
              <button
                *ngIf="editMode && dependentInfos.length > 1"
                type="button"
                class="ghost"
                (click)="removeDependentInfo(i)"
                style="color: #d32f2f;"
              >
                削除
              </button>
            </div>
            <div class="grid three-col">
          <div>
            <label>続柄</label>
            <input
                  [name]="'dependentRelationship' + i"
              [(ngModel)]="dependentInfo.relationship"
              [readonly]="!editMode"
            />
          </div>
          <div>
            <label>氏名（漢字）</label>
            <input
                  [name]="'dependentNameKanji' + i"
              [(ngModel)]="dependentInfo.nameKanji"
              [readonly]="!editMode"
            />
          </div>
          <div>
            <label>氏名（カナ）</label>
            <input
                  [name]="'dependentNameKana' + i"
              [(ngModel)]="dependentInfo.nameKana"
              [readonly]="!editMode"
            />
          </div>
          <div>
            <label>生年月日</label>
            <input
              type="date"
                  [name]="'dependentBirthDate' + i"
              [(ngModel)]="dependentInfo.birthDate"
              [readonly]="!editMode"
            />
          </div>
          <div>
            <label>性別</label>
            <select
                  [name]="'dependentGender' + i"
              [(ngModel)]="dependentInfo.gender"
              [disabled]="!editMode"
            >
              <option value="">選択してください</option>
              <option value="男性">男性</option>
              <option value="女性">女性</option>
            </select>
          </div>
          <div>
            <label>個人番号</label>
            <input
                  [name]="'dependentPersonalNumber' + i"
              [(ngModel)]="dependentInfo.personalNumber"
              [readonly]="!editMode"
            />
          </div>
          <div>
            <label>基礎年金番号</label>
            <input
                  [name]="'dependentBasicPensionNumber' + i"
              [(ngModel)]="dependentInfo.basicPensionNumber"
              [readonly]="!editMode"
            />
          </div>
          <div>
            <label>同居区分</label>
            <input
                  [name]="'dependentCohabitationType' + i"
              [(ngModel)]="dependentInfo.cohabitationType"
              [readonly]="!editMode"
            />
          </div>
          <div>
            <label>住所（別居の場合のみ）</label>
            <input
                  [name]="'dependentAddress' + i"
              [(ngModel)]="dependentInfo.address"
              [readonly]="!editMode"
            />
          </div>
          <div>
            <label>職業</label>
            <input
                  [name]="'dependentOccupation' + i"
              [(ngModel)]="dependentInfo.occupation"
              [readonly]="!editMode"
            />
          </div>
          <div>
            <label>年収（見込み）</label>
            <input
              type="number"
                  [name]="'dependentAnnualIncome' + i"
              [(ngModel)]="dependentInfo.annualIncome"
              [readonly]="!editMode"
            />
          </div>
          <div>
            <label>被扶養者になった日</label>
            <input
              type="date"
                  [name]="'dependentStartDate' + i"
              [(ngModel)]="dependentInfo.dependentStartDate"
              [readonly]="!editMode"
            />
          </div>
          <div>
            <label>国民年金第3号被保険者該当フラグ</label>
            <label class="switch">
              <input
                type="checkbox"
                    [name]="'dependentThirdCategoryFlag' + i"
                [(ngModel)]="dependentInfo.thirdCategoryFlag"
                [disabled]="!editMode"
              />
              <span></span>
            </label>
              </div>
            </div>
          </div>
          <div *ngIf="dependentInfos.length === 0 && editMode" style="text-align: center; padding: 2rem;">
            <p class="hint">「＋扶養情報追加」ボタンから扶養情報を追加してください。</p>
          </div>
        </div>
        <ng-template #noDependentNotice>
          <p class="hint">扶養の有無を「有」にすると入力欄が表示されます。</p>
        </ng-template>
      </article>

      <article class="card approval-section" *ngIf="!isViewModeFromApproval">
        <div class="card-header">
          <div>
            <h2>承認依頼</h2>
          </div>
        </div>

        <div class="approval-grid">
          <div class="approval-summary">
            <p class="label">対象社員件数</p>
            <p class="value">1 件</p>
            <ul>
              <li>新規登録：1 件</li>
            </ul>
          </div>
          <div class="approval-form">
            <app-flow-selector
              [label]="'承認ルート'"
              [selectedFlowId]="selectedFlowId"
              (flowSelected)="onFlowSelected($event)"
              (flowsUpdated)="onFlowsUpdated($event)"
            />
            <label class="field">
              <div class="field-header">
                <span>申請コメント</span>
                <span class="hint" [class.warning]="requestComment.length >= 450">
                  {{ requestComment.length }}/500 文字
                </span>
              </div>
              <textarea name="requestComment" rows="4" [(ngModel)]="requestComment" placeholder="例：新規社員の登録です。" maxlength="500"></textarea>
            </label>
            <div class="attachment-box">
              <div class="attachment-header">
                <div>
                  <p class="label">申請時の添付</p>
                  <p class="hint">1件10MB以内・最大5件・合計30MB</p>
                </div>
                <label class="upload-button">
                  <input
                    type="file"
                    multiple
                    (change)="onFileSelected($event)"
                    [accept]="attachmentService.acceptExtensions"
                  />
                  ファイルを選択
                </label>
              </div>
              <p class="hint">合計サイズ: {{ formatFileSize(totalSelectedSize()) }}</p>
              <p class="hint warning" *ngIf="validationErrors.length">{{ validationErrors[0] }}</p>
              <ul class="selected-files" *ngIf="selectedFiles.length">
                <li *ngFor="let file of selectedFiles; let i = index">
                  <div>
                    <p class="file-name">{{ file.name }}</p>
                    <p class="hint">{{ formatFileSize(file.size) }}</p>
                  </div>
                  <button type="button" class="ghost" (click)="removeFile(i)">削除</button>
                </li>
              </ul>
            </div>
          </div>
        </div>

        <p class="message" *ngIf="approvalMessage">{{ approvalMessage }}</p>
        <p class="hint" *ngIf="!approvalMessage">承認完了後新規社員の情報は登録されます。</p>
      </article>
  
      <div class="action-bar" *ngIf="!isViewModeFromApproval">
        <button type="button" class="primary" (click)="handleProceedApproval(employeeForm)" [disabled]="isLoading || sendingApproval || !selectedFlowId">承認依頼を送信</button>
        <a routerLink="/employees" class="outline ghost">キャンセル</a>
      </div>
    </form>
  </section>