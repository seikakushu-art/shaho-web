<section class="user-management">
    <header class="page-header">
      <div>
        <h1>ユーザー管理</h1>
      </div>
    </header>
  
    <section class="card">
      <header>
        <div class="title-with-note">
          <h2>新規登録/編集</h2>
          <span class="edit-note">編集するには、まずメールアドレスを入力してください。</span>
        </div>
        <div class="header-actions">
          <button type="button" class="ghost" (click)="resetForm()">入力をクリア</button>
          <button
            type="button"
            class="danger"
            (click)="deleteByEmailInput()"
            [disabled]="!(canEdit$ | async) || form.controls['email'].invalid"
          >
            削除
          </button>
        </div>
      </header>
  
      <form [formGroup]="form" (ngSubmit)="saveUser()" class="form-grid">
        <label>
          <span>メールアドレス</span>
          <input type="email" formControlName="email" placeholder="user@example.com" [disabled]="!(canEdit$ | async)" />
        </label>

        <label>
          <span>表示名</span>
          <input type="text" formControlName="displayName" placeholder="yamada taro" [disabled]="!(canEdit$ | async) || isExistingUser" />
          <p class="error" *ngIf="submitted && form.controls['displayName'].hasError('required')">
            表示名を入力してください。
          </p>
          <p class="error" *ngIf="form.controls['displayName'].hasError('displayNameDuplicate')">
            {{ form.controls['displayName'].getError('displayNameDuplicate')?.message }}
          </p>
        </label>

        <div class="roles">
          <div class="assigned-roles">
            <span class="hint" *ngIf="!form.value.role">ロールが未選択です</span>
          </div>
          <div class="role-list">
            <label *ngFor="let role of roleDefinitions">
              <input
                type="radio"
                [value]="role.key"
                formControlName="role"
                [disabled]="!(canEdit$ | async)"
              />
              <span class="role-name">{{ role.name }}</span>
              <small>{{ role.summary }}</small>
            </label>
          </div>
          <p class="error" *ngIf="form.controls['role'].hasError('required')">ロールを1つ選択してください。</p>
        </div>

        <div class="actions">
          <button type="submit" class="primary" [disabled]="!(canEdit$ | async)">
            登録する
          </button>
          <span class="status" *ngIf="statusMessage">{{ statusMessage }}</span>
        </div>
      </form>
    </section>
  
    <section class="card">
      <header>
        <h2>登録済み</h2>
      </header>
  
      <div class="user-list">
        <article class="user" *ngFor="let user of users$ | async">
          <div>
            <h3>{{ user.displayName || user.email }}</h3>
            <p class="hint">{{ user.email }}</p>
          </div>
          <div class="roles-label">
            {{ getRoleNames(user.roles) }}
          </div>
          <div class="actions">
            <button
            type="button"
            class="danger"
            (click)="deleteUser(user); $event.stopPropagation()"
            [disabled]="!(canEdit$ | async)"
          >
            削除
          </button>
          </div>
        </article>
      </div>
    </section>
  </section>