<section class="calculation-result">
  <header>
    <h1>結果確認</h1>
    <div class="meta">
      <span>計算種別: {{ calculationTypeLabel }}</span>
      <span>{{ targetYearMonthLabel }}: {{ targetYearMonthValue }}</span>
      <span *ngIf="bonusPaidOnFilter && calculationType !== 'standard'">賞与支給日: {{ bonusPaidOnFilter }}</span>
      <span *ngIf="calculationType !== 'standard'">保険種別: {{ activeInsurances.join(' / ') }}</span>
    </div>
  </header>

  <div class="controls card">
    <div class="control-row">
      <button type="button" (click)="autoHideIrrelevant()">計算対象に応じて不要列を非表示</button>
      <button type="button" (click)="saveResults()" [disabled]="saving">
        {{ saving ? '保存中...' : '保存' }}
      </button>
      <button type="button" class="secondary" (click)="goToCsvExport()">
        計算結果CSV出力
      </button>
      <button
        *ngIf="currentHistoryId"
        type="button"
        class="primary"
        (click)="goToApprovalFlow()"
      >
        承認フローに進む
      </button>
    </div>
    <div class="notice">
      <app-flow-selector
        [label]="'保存前に承認フローを選択'"
        [selectedFlowId]="selectedFlowId"
        (flowSelected)="onFlowSelected($event)"
        (flowsUpdated)="onFlowsUpdated($event)"
      ></app-flow-selector>
      <p class="hint">承認完了後に計算結果を保存します。</p>
    </div>
    <div class="column-selector">
      <div class="checkboxes">
        <label *ngFor="let column of columns">
          <input type="checkbox" [checked]="column.visible" (change)="toggleColumn(column.key)" />
          {{ column.label }}
        </label>
      </div>
    </div>
  </div>

  <p class="message" *ngIf="approvalMessage">{{ approvalMessage }}</p>

  <div class="card">
    <div class="table-wrapper">
    <table class="result-table">
      <thead>
        <tr>
            <th
              *ngFor="let column of visibleColumns"
              (click)="sortBy(column.key)"
              [class.sortable]="column.sortable"
            >
              <ng-container [ngSwitch]="column.key">
                <ng-container *ngSwitchCase="'department'">
                  <div class="header-select">
                    <span>{{ column.label }}</span>
                    <select
                      [value]="departmentFilter"
                      (change)="onDepartmentFilterChange($any($event.target).value)"
                      (click)="$event.stopPropagation()"
                    >
                      <option value="">すべて</option>
                      <option *ngFor="let dept of departmentOptions" [value]="dept">
                        {{ dept }}
                      </option>
                    </select>
                  </div>
                </ng-container>
                <ng-container *ngSwitchCase="'location'">
                  <div class="header-select">
                    <span>{{ column.label }}</span>
                    <select
                      [value]="locationFilter"
                      (change)="onLocationFilterChange($any($event.target).value)"
                      (click)="$event.stopPropagation()"
                    >
                      <option value="">すべて</option>
                      <option *ngFor="let loc of locationOptions" [value]="loc">
                        {{ loc }}
                      </option>
                    </select>
                  </div>
                </ng-container>
                <ng-container *ngSwitchDefault>
            {{ column.label }}
                </ng-container>
              </ng-container>
              <span *ngIf="column.sortable && sortKey === column.key">{{
                sortDirection === 'asc' ? '▲' : '▼'
              }}</span>
          </th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let row of rows" [class.error-row]="row.error">
          <ng-container *ngIf="row.error; else normalRow">
            <td [attr.colspan]="visibleColumns.length" class="error-message">
              <strong>エラー:</strong> {{ row.error }}
            </td>
          </ng-container>
          <ng-template #normalRow>
              <td *ngFor="let column of visibleColumns" [class.money]="column.format === 'money'" [class.no-wrap]="noWrapColumns.includes(column.key)">
              {{ getDisplayValue(row, column) }}
            </td>
          </ng-template>
        </tr>
      </tbody>
    </table>
    </div>
  </div>

  <div class="summary-grid">
    <div class="card wide" *ngIf="calculationType === 'insurance'">
      <div class="table-caption">保険種別別まとめ</div>
      <div class="table-wrapper">
      <table class="result-table compact">
        <thead>
          <tr>
            <th>保険種別</th>
            <th>個人負担</th>
            <th>会社負担</th>
            <th>合計</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let insurance of insuranceSummaries">
            <td>{{ insurance.type }}</td>
            <td class="money">{{ insurance.employee | number }}</td>
            <td class="money">{{ insurance.employer | number }}</td>
            <td class="money">{{ insurance.total | number }}</td>
          </tr>
        </tbody>
      </table>
    </div>
    </div>
  </div>
</section>