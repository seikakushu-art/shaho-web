<section class="calculation-result">
  <header>
    <p class="eyebrow">結果画面（2.4.3）</p>
    <h1>計算結果の確認と調整</h1>
    <p class="hint">
      対象項目の自動非表示・並び替え・表示項目選択に対応した結果テーブルです。承認フローへの遷移フックも用意しています。
    </p>
    <div class="meta">
      <span>計算種別: {{ calculationType }}</span>
      <span>対象年月: {{ targetMonth }}</span>
      <span *ngIf="bonusMonth">賞与対象: {{ bonusMonth }}</span>
      <span>計算方法: {{ method }}</span>
      <span>保険種別: {{ activeInsurances.join(' / ') }}</span>
    </div>
  </header>

  <div class="controls card">
    <div class="control-row">
      <button type="button" (click)="autoHideIrrelevant()">計算対象に応じて不要列を非表示</button>
      <button type="button" class="primary" (click)="goToApprovalFlow()">承認フローに進む</button>
    </div>
    <div class="column-selector">
      <p class="eyebrow">表示項目の選択</p>
      <div class="checkboxes">
        <label *ngFor="let column of columns">
          <input type="checkbox" [checked]="column.visible" (change)="toggleColumn(column.key)" />
          {{ column.label }}
        </label>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="table-caption">計算結果</div>
    <table class="result-table">
      <thead>
        <tr>
          <th *ngFor="let column of visibleColumns" (click)="sortBy(column.key)" [class.sortable]="column.sortable">
            {{ column.label }}
            <span *ngIf="column.sortable && sortKey === column.key">{{ sortDirection === 'asc' ? '▲' : '▼' }}</span>
          </th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let row of rows">
          <td *ngFor="let column of visibleColumns" [class.money]="column.format === 'money'">
            {{ getDisplayValue(row, column) }}
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="summary-grid">
    <div class="card">
      <div class="table-caption">対象年月・部署別集計</div>
      <table class="result-table compact">
        <thead>
          <tr>
            <th>対象年月</th>
            <th>部署</th>
            <th>対象人数</th>
            <th>月給支払額</th>
            <th>賞与総支給額</th>
            <th *ngIf="showMonthlyBreakdown" colspan="3">月例分</th>
            <th *ngIf="showBonusBreakdown" colspan="4">賞与分</th>
            <th rowspan="2">個人負担合計</th>
            <th rowspan="2">会社負担合計</th>
            <th rowspan="2">総計</th>
          </tr>
          <tr *ngIf="showMonthlyBreakdown || showBonusBreakdown">
            <ng-container *ngIf="showMonthlyBreakdown">
              <th>個人負担</th>
              <th>会社負担</th>
              <th>合計</th>
            </ng-container>
            <ng-container *ngIf="showBonusBreakdown">
              <th>標準賞与額</th>
              <th>個人負担</th>
              <th>会社負担</th>
              <th>合計</th>
            </ng-container>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let summary of departmentSummaries">
            <td>{{ summary.month }}</td>
            <td>{{ summary.department }}</td>
            <td>{{ summary.headcount }}</td>
            <td class="money">{{ summary.monthlyPay | number }}</td>
            <td class="money">{{ summary.bonusPay | number }}</td>
            <ng-container *ngIf="showMonthlyBreakdown">
              <td class="money">{{ summary.monthlyEmployeeShare | number }}</td>
              <td class="money">{{ summary.monthlyEmployerShare | number }}</td>
              <td class="money">{{ summary.monthlyTotal | number }}</td>
            </ng-container>
            <ng-container *ngIf="showBonusBreakdown">
              <td class="money">{{ summary.bonusStandardBonus | number }}</td>
              <td class="money">{{ summary.bonusEmployeeShare | number }}</td>
              <td class="money">{{ summary.bonusEmployerShare | number }}</td>
              <td class="money">{{ summary.bonusTotal | number }}</td>
            </ng-container>
            <td class="money">{{ summary.employeeShare | number }}</td>
            <td class="money">{{ summary.employerShare | number }}</td>
            <td class="money">{{ summary.total | number }}</td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="card">
      <div class="table-caption">保険種別別まとめ</div>
      <table class="result-table compact">
        <thead>
          <tr>
            <th>保険種別</th>
            <th>個人負担</th>
            <th>会社負担</th>
            <th>合計</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let insurance of insuranceSummaries">
            <td>{{ insurance.type }}</td>
            <td class="money">{{ insurance.employee | number }}</td>
            <td class="money">{{ insurance.employer | number }}</td>
            <td class="money">{{ insurance.total | number }}</td>
          </tr>
        </tbody>
      </table>
    </div>
    <div class="card">
      <div class="table-caption">対象年月・保険種別内訳</div>
      <table class="result-table compact">
        <thead>
          <tr>
            <th>対象年月</th>
            <th>保険種別</th>
            <th *ngIf="showMonthlyBreakdown" colspan="3">月例分</th>
            <th *ngIf="showBonusBreakdown" colspan="4">賞与分</th>
            <th rowspan="2">合計</th>
          </tr>
          <tr *ngIf="showMonthlyBreakdown || showBonusBreakdown">
            <ng-container *ngIf="showMonthlyBreakdown">
              <th>個人負担</th>
              <th>会社負担</th>
              <th>合計</th>
            </ng-container>
            <ng-container *ngIf="showBonusBreakdown">
              <th>標準賞与額</th>
              <th>個人負担</th>
              <th>会社負担</th>
              <th>合計</th>
            </ng-container>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let summary of insuranceMonthlySummaries">
            <td>{{ summary.month }}</td>
            <td>{{ summary.insurance }}</td>
            <ng-container *ngIf="showMonthlyBreakdown">
              <td class="money">{{ summary.monthlyEmployee | number }}</td>
              <td class="money">{{ summary.monthlyEmployer | number }}</td>
              <td class="money">{{ summary.monthlyTotal | number }}</td>
            </ng-container>
            <ng-container *ngIf="showBonusBreakdown">
              <td class="money">{{ summary.standardBonus | number }}</td>
              <td class="money">{{ summary.bonusEmployee | number }}</td>
              <td class="money">{{ summary.bonusEmployer | number }}</td>
              <td class="money">{{ summary.bonusTotal | number }}</td>
            </ng-container>
            <td class="money">{{ summary.total | number }}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</section>