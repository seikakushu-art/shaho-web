<section class="calculation-result">
  <header>
    <h1>結果確認</h1>
    <div class="meta">
      <span class="meta-item">
        <span class="meta-label">計算種別</span>
        <span class="meta-value">{{ calculationTypeLabel }}</span>
      </span>
      <span class="meta-item" *ngIf="targetYearMonthLabel">
        <span class="meta-label">{{ targetYearMonthLabel }}</span>
        <span class="meta-value">{{ targetYearMonthValue }}</span>
      </span>
      <span class="meta-item" *ngIf="bonusPaidOnFilter && calculationType !== 'standard'">
        <span class="meta-label">賞与支給日</span>
        <span class="meta-value">{{ bonusPaidOnFilter }}</span>
      </span>
      <span class="meta-item" *ngIf="calculationType === 'standard'">
        <span class="meta-label">標準報酬月額の算定方法</span>
        <span class="meta-value">{{ standardMethod }}</span>
      </span>
      <span class="meta-item" *ngIf="calculationType !== 'standard'">
        <span class="meta-label">保険種別</span>
        <span class="meta-value">{{ activeInsurances.join(' / ') }}</span>
      </span>
    </div>
  </header>

  <div class="controls card">
    <div class="control-row" *ngIf="!isViewMode">
      <button type="button" (click)="autoHideIrrelevant()">計算対象に応じて不要列を非表示</button>
      <button type="button" class="secondary" (click)="goToCsvExport()">
        計算結果CSV出力
      </button>
    </div>
    <div class="column-selector">
      <div class="checkboxes">
        <label *ngFor="let column of columns">
          <input type="checkbox" [checked]="column.visible" (change)="toggleColumn(column.key)" />
          {{ column.label }}
        </label>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="table-wrapper">
    <table class="result-table">
      <thead>
        <tr>
            <th
              *ngFor="let column of visibleColumns"
              (click)="sortBy(column.key)"
              [class.sortable]="column.sortable"
            >
              <ng-container [ngSwitch]="column.key">
                <ng-container *ngSwitchCase="'department'">
                  <div class="header-select">
                    <span>{{ column.label }}</span>
                    <select
                      [value]="departmentFilter"
                      (change)="onDepartmentFilterChange($any($event.target).value)"
                      (click)="$event.stopPropagation()"
                    >
                      <option value="">すべて</option>
                      <option *ngFor="let dept of departmentOptions" [value]="dept">
                        {{ dept }}
                      </option>
                    </select>
                  </div>
                </ng-container>
                <ng-container *ngSwitchCase="'location'">
                  <div class="header-select">
                    <span>{{ column.label }}</span>
                    <select
                      [value]="locationFilter"
                      (change)="onLocationFilterChange($any($event.target).value)"
                      (click)="$event.stopPropagation()"
                    >
                      <option value="">すべて</option>
                      <option *ngFor="let loc of locationOptions" [value]="loc">
                        {{ loc }}
                      </option>
                    </select>
                  </div>
                </ng-container>
                <ng-container *ngSwitchDefault>
            {{ column.label }}
                </ng-container>
              </ng-container>
              <span *ngIf="column.sortable && sortKey === column.key">{{
                sortDirection === 'asc' ? '▲' : '▼'
              }}</span>
          </th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let row of rows" [class.error-row]="row.error">
          <ng-container *ngIf="row.error; else normalRow">
            <td [attr.colspan]="visibleColumns.length" class="error-message">
              <strong>エラー:</strong> {{ row.error }}
            </td>
          </ng-container>
          <ng-template #normalRow>
              <td *ngFor="let column of visibleColumns" [class.money]="column.format === 'money'" [class.no-wrap]="noWrapColumns.includes(column.key)">
              {{ getDisplayValue(row, column) }}
            </td>
          </ng-template>
        </tr>
      </tbody>
    </table>
    </div>
  </div>

  <div class="summary-grid">
    <div class="card wide" *ngIf="calculationType === 'insurance'">
      <div class="table-caption">保険種別まとめ</div>
      <div class="table-wrapper">
      <table class="result-table compact">
        <thead>
          <tr>
            <th>保険種別</th>
            <th>個人負担</th>
            <th>会社負担</th>
            <th>合計</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let insurance of insuranceSummaries" [class.error-row]="insurance.error">
            <td>{{ insurance.type }}</td>
            <ng-container *ngIf="insurance.error; else normalRow">
              <td class="money">{{ insurance.employee | number }}</td>
              <td [attr.colspan]="2" class="error-message">
                <strong>エラー:</strong> {{ insurance.error }}
              </td>
            </ng-container>
            <ng-template #normalRow>
              <td class="money">{{ insurance.employee | number }}</td>
              <td class="money">{{ insurance.employer | number }}</td>
              <td class="money">{{ insurance.total | number }}</td>
            </ng-template>
          </tr>
        </tbody>
      </table>
    </div>
    </div>
  </div>

  <div class="card approval-section" *ngIf="!isViewMode && !currentHistoryId">
    <div class="approval-grid">
      <div class="approval-summary">
        <p class="label">対象社員件数</p>
        <p class="value">{{ validRowsCount }} 件</p>
        <ul>
          <li>計算対象：{{ validRowsCount }} 件</li>
          <li>エラー除外：{{ errorRowsCount }} 件</li>
        </ul>
      </div>
      <div class="approval-form">
        <app-flow-selector
          [label]="'承認ルート'"
          [selectedFlowId]="selectedFlowId"
          (flowSelected)="onFlowSelected($event)"
          (flowsUpdated)="onFlowsUpdated($event)"
        />
        <label class="field">
          <div class="field-header">
            <span>申請コメント</span>
            <span class="hint" [class.warning]="requestComment.length >= 450">
              {{ requestComment.length }}/500 文字
            </span>
          </div>
          <textarea name="requestComment" rows="4" [(ngModel)]="requestComment" placeholder="例：標準報酬月額の計算結果を保存します。" maxlength="500"></textarea>
        </label>
        <div class="attachment-box">
          <div class="attachment-header">
            <div>
              <p class="label">申請時の添付</p>
              <p class="hint">1件10MB以内・最大5件・合計30MB</p>
            </div>
            <label class="upload-button">
              <input
                type="file"
                multiple
                (change)="onFileSelected($event)"
                [accept]="attachmentService.acceptExtensions"
              />
              ファイルを選択
            </label>
          </div>
          <p class="hint">合計サイズ: {{ formatFileSize(totalSelectedSize()) }}</p>
          <p class="hint warning" *ngIf="validationErrors.length">{{ validationErrors[0] }}</p>
          <ul class="selected-files" *ngIf="selectedFiles.length">
            <li *ngFor="let file of selectedFiles; let i = index">
              <div>
                <p class="file-name">{{ file.name }}</p>
                <p class="hint">{{ formatFileSize(file.size) }}</p>
              </div>
              <button type="button" class="ghost" (click)="removeFile(i)">削除</button>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <p class="message" *ngIf="approvalMessage">{{ approvalMessage }}</p>
    <div class="navigation" *ngIf="!isViewMode">
      <span></span>
      <button type="button" class="primary" (click)="saveResults()" [disabled]="saving || !selectedFlowId">
        {{ saving ? '保存中...' : '承認依頼を送信' }}
      </button>
    </div>
  </div>
</section>