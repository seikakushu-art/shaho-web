<div class="flow-management" *ngIf="!loading; else loadingTpl">
    <section class="list">
      <header>
        <div>
          <h2>承認フロー</h2>
        </div>
      </header>
  
      <div *ngIf="flows.length; else noFlow">
        <table>
          <thead>
            <tr>
              <th>フロー名</th>
              <th>ステップ</th>
              <th>最終更新</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let flow of flows" [class.active]="flow.id === editing?.id">
              <td>
                <div class="flow-name">{{ flow.name }}</div>
                <div class="steps">{{ flow.steps.length }}ステップ / {{ flowStepNames(flow) }}</div>
              </td>
              <td>{{ flow.steps.length }}</td>
              <td>
                <span *ngIf="flow.updatedAt as updated">{{ updated.toDate() | date: 'yyyy/MM/dd HH:mm' }}</span>
                <span *ngIf="!flow.updatedAt" class="muted">未設定</span>
              </td>
              <td class="actions">
                <button type="button" (click)="selectFlow(flow)">編集</button>
                <button type="button" class="danger" (click)="deleteFlow(flow)">削除</button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <ng-template #noFlow>
        <p class="hint">承認フローがありません。右側のフォームから作成してください。</p>
      </ng-template>
    </section>
  
    <section class="editor">
      <header>
        <div>
          <h2>{{ editing ? '承認フロー編集' : '承認フロー新規作成' }}</h2>
        </div>
        <button type="button" class="secondary" (click)="resetForm()">クリア</button>
      </header>
  
      <form (ngSubmit)="saveFlow()">
        <label class="field">
          <span>フロー名</span>
          <input type="text" [(ngModel)]="draft.name" name="name" placeholder="例: 給与・社保承認フロー" required />
        </label>

        <div class="steps-block">
          <div class="block-header">
            <h3>ステップ（最大{{ maxSteps }}）</h3>
            <button type="button" (click)="addStep()" [disabled]="draft.steps.length >= maxSteps">ステップ追加</button>
          </div>
  
          <article class="step" *ngFor="let step of draft.steps; let i = index">
            <header>
              <div class="title">{{ step.order }}. {{ step.name || 'ステップ' + step.order }}</div>
              <div class="controls">
                <button type="button" (click)="moveStep(i, 'up')" [disabled]="i === 0">▲</button>
                <button type="button" (click)="moveStep(i, 'down')" [disabled]="i === draft.steps.length - 1">▼</button>
                <button type="button" class="danger" (click)="removeStep(i)" [disabled]="draft.steps.length === 1">削除</button>
              </div>
            </header>
  
            <label class="field inline">
              <span>ステップ名</span>
              <input type="text" [(ngModel)]="step.name" name="step-name-{{ i }}" />
            </label>
  
            <div class="field inline candidates">
              <span>候補者</span>
              <div class="candidate-input">
                <select [(ngModel)]="candidateInputs[step.order]" name="candidate-{{ i }}">
                  <option [ngValue]="''">ユーザーを選択</option>
                  <option *ngFor="let user of users" [ngValue]="user.id">{{ user.displayName }}</option>
                </select>
                <button type="button" (click)="addCandidate(step, candidateInputs[step.order])" [disabled]="!candidateInputs[step.order]">追加</button>
              </div>
              <div class="chips">
                <span class="chip" *ngFor="let candidate of step.candidates">
                  {{ candidate.displayName }}
                  <button type="button" (click)="removeCandidate(step, candidate)">×</button>
                </span>
                <span class="muted" *ngIf="!step.candidates.length">候補者未設定</span>
              </div>
            </div>
          </article>
        </div>
  
        <div class="actions">
          <button type="submit" [disabled]="loading">{{ editing ? '更新' : '作成' }}</button>
          <span class="notice" *ngIf="notice">{{ notice }}</span>
        </div>
      </form>
    </section>
  </div>
  
  <ng-template #loadingTpl>
    <p>読込中...</p>
  </ng-template>